{% extends "base.html" %}

{% block title %}Bitcoin Weekly MACD (12, 26, 9){% endblock %}

{% block content %}
<style>
    :root {
        --coinbase-blue: #0052FF;
        --apple-gray: #F5F5F7;
        --apple-dark: #1D1D1F;
        --success-green: #00D632;
        --danger-red: #FF3B30;
        --light-green: #e6ffe6;
        --light-red: #ffe6e6;
        --light-yellow: rgba(255, 204, 0, 0.2);
    }

    body {
        background-color: var(--apple-gray);
        color: var(--apple-dark);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .container {
        max-width: 1200px;
        padding: 2rem;
    }

    h2 {
        font-weight: 600;
        color: var(--apple-dark);
        margin-bottom: 2rem;
    }

    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        background: linear-gradient(135deg, var(--coinbase-blue), #0038B3);
        border: none;
        padding: 1.5rem;
    }

    .card-header h3 {
        font-weight: 600;
        margin: 0;
        color: white;
    }

    .card-body {
        padding: 2rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        font-weight: 600;
        color: #6E6E73;
        border-top: none;
    }

    .table td {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        vertical-align: middle;
    }

    .badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
    }

    .bg-success {
        background-color: var(--success-green) !important;
    }

    .bg-danger {
        background-color: var(--danger-red) !important;
    }

    .text-success {
        color: var(--success-green) !important;
    }

    .text-danger {
        color: var(--danger-red) !important;
    }

    .alert {
        border: none;
        border-radius: 12px;
        padding: 1.5rem;
    }

    .alert-success {
        background-color: rgba(0, 214, 50, 0.1);
        color: var(--success-green);
    }

    .alert-danger {
        background-color: rgba(255, 59, 48, 0.1);
        color: var(--danger-red);
    }

    .historical-row {
        transition: all 0.3s ease;
    }

    .historical-row:hover {
        background-color: rgba(0, 82, 255, 0.05);
        transform: translateX(4px);
    }

    .table-responsive {
        border-radius: 12px;
        overflow: hidden;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.02);
    }

    h4 {
        font-weight: 600;
        color: var(--apple-dark);
        margin-bottom: 1.5rem;
    }

    h5 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    #signalAnalysis p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    .btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: var(--coinbase-blue);
        border: none;
    }

    .btn-primary:hover {
        background-color: #0038B3;
        transform: translateY(-1px);
    }

    .chart-container {
        position: relative;
        height: 380px;
        width: 100%;
    }

    .analysis-section {
        padding: 1.5rem;
        background-color: var(--apple-gray);
        border-radius: 12px;
        margin-top: 1rem;
    }

    .analysis-section h5 {
        color: var(--apple-dark);
        margin-bottom: 0.5rem;
    }

    .analysis-section p {
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">Bitcoin Weekly MACD Analysis</h2>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% else %}
        <!-- MACD Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">MACD Chart</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="macdChart"></canvas>
                </div>
                <div class="text-center mt-2" style="color: #6E6E73; font-size: 0.9rem;">
                    Monday's of the Week
                </div>
            </div>
        </div>

        <!-- Current Week Analysis -->
        <div class="card mb-4" id="currentWeekCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Selected Week Analysis</h3>
                <button id="currentWeekBtn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Current Week
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Weekly Performance</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <th>Date:</th>
                                    <td id="selectedDate">{{ analysis.current_week_data.date_formatted }}</td>
                                </tr>
                                <tr>
                                    <th>Price:</th>
                                    <td id="selectedPrice">${{ "%.2f"|format(analysis.current_week_data.price) }}</td>
                                </tr>
                                <tr>
                                    <th>MACD:</th>
                                    <td id="selectedMACD">{{ "%.4f"|format(analysis.current_week_data.macd) }}</td>
                                </tr>
                                <tr>
                                    <th>Signal:</th>
                                    <td id="selectedSignal">{{ "%.4f"|format(analysis.current_week_data.signal) }}</td>
                                </tr>
                                <tr>
                                    <th>Distance:</th>
                                    <td id="selectedDistance" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.4f"|format(analysis.current_week_data.distance) }}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Trend:</th>
                                    <td>
                                        <span id="selectedTrend" class="badge {% if analysis.current_week_data.distance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ 'Bullish' if analysis.current_week_data.distance > 0 else 'Bearish' }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Analysis & Recommendation</h4>
                        <div class="analysis-section">
                            <h5>Current Status:</h5>
                            <p id="selectedStatus" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if analysis.current_week_data.distance > 0 %}
                                    {% if analysis.previous_week_data and analysis.previous_week_data.distance <= 0 %}
                                        <strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.
                                    {% elif analysis.previous_week_data and analysis.current_week_data.distance < analysis.previous_week_data.distance %}
                                        <strong>First Reversal Warning!</strong> MACD momentum is decreasing.
                                    {% else %}
                                        MACD remains above signal line.
                                    {% endif %}
                                {% else %}
                                    {% if analysis.previous_week_data and analysis.previous_week_data.distance > 0 %}
                                        <strong>Death Cross Alert!</strong> MACD has crossed below the signal line.
                                    {% elif analysis.previous_week_data and analysis.current_week_data.distance > analysis.previous_week_data.distance %}
                                        <strong>First Reversal Warning!</strong> MACD momentum is increasing.
                                    {% else %}
                                        MACD remains below signal line.
                                    {% endif %}
                                {% endif %}
                            </p>
                            <h5>Recommendation:</h5>
                            <p id="selectedRecommendation" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if analysis.current_week_data.distance > 0 %}
                                    {% if analysis.previous_week_data and analysis.previous_week_data.distance <= 0 %}
                                        <strong>BUY SIGNAL:</strong> Golden Cross detected. Consider entering long positions.
                                    {% elif analysis.previous_week_data and analysis.current_week_data.distance < analysis.previous_week_data.distance %}
                                        <strong>PARTIAL SELL RECOMMENDATION:</strong> Consider selling 10-20% of your position. Hold the rest until Death Cross.
                                    {% else %}
                                        Hold existing positions. MACD remains bullish.
                                    {% endif %}
                                {% else %}
                                    {% if analysis.previous_week_data and analysis.previous_week_data.distance > 0 %}
                                        <strong>SELL SIGNAL:</strong> Death Cross detected. Exit all positions.
                                    {% elif analysis.previous_week_data and analysis.current_week_data.distance > analysis.previous_week_data.distance %}
                                        <strong>PARTIAL BUY OPPORTUNITY:</strong> Consider buying 10-20% of your position. Hold the rest until Golden Cross.
                                    {% else %}
                                        Stay on the sidelines. MACD remains bearish.
                                    {% endif %}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Analysis -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Historical Analysis (2024-2025)</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Price</th>
                                <th>MACD</th>
                                <th>Signal</th>
                                <th>Distance</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in weekly_data %}
                                {% if week.monday_date.startswith('2024') or week.monday_date.startswith('2025') %}
                                {% set current_index = loop.index0 %}
                                {% set prev_week = weekly_data[current_index - 1] if current_index > 0 else none %}
                                {% set prev_prev_week = weekly_data[current_index - 2] if current_index > 1 else none %}
                                
                                {% set is_golden_cross = week.distance > 0 and prev_week and prev_week.distance <= 0 %}
                                {% set is_death_cross = week.distance < 0 and prev_week and prev_week.distance >= 0 %}
                                
                                {% set is_partial_sell = week.distance > 0 and prev_week and prev_prev_week and 
                                                         week.macd < prev_week.macd and prev_week.macd > prev_prev_week.macd %}
                                
                                {% set is_partial_buy = week.distance < 0 and prev_week and prev_prev_week and 
                                                       week.macd > prev_week.macd and prev_week.macd < prev_prev_week.macd %}
                                
                                <tr class="historical-row" 
                                    data-index="{{ current_index }}"
                                    data-date="{{ week.monday_date }}"
                                    data-price="{{ week.price }}"
                                    data-macd="{{ week.macd }}"
                                    data-signal="{{ week.signal }}"
                                    data-distance="{{ week.distance }}"
                                    {% if is_golden_cross %}
                                        style="background-color: #e6ffe6; font-weight: bold;"
                                    {% elif is_death_cross %}
                                        style="background-color: #ffe6e6; font-weight: bold;"
                                    {% elif is_partial_sell %}
                                        style="background-color: #fff0f0; font-weight: bold;"
                                    {% elif is_partial_buy %}
                                        style="background-color: #f0fff0; font-weight: bold;"
                                    {% endif %}>
                                    <td>{{ week.date_formatted }}</td>
                                    <td>${{ "%.2f"|format(week.price) }}</td>
                                    <td>{{ "%.4f"|format(week.macd) }}</td>
                                    <td>{{ "%.4f"|format(week.signal) }}</td>
                                    <td>{{ "%.4f"|format(week.distance) }}</td>
                                    <td>
                                        {% if week.distance > 0 %}
                                            {% if is_golden_cross %}
                                                <span style="color: #00D632; font-weight: bold; font-size: 1.2em;">Welcome to the Bull Market! 🚀</span>
                                                <br><small style="color: #00D632; font-weight: bold; font-size: 1.1em;">
                                                    <strong>BUY! BUY! BUY!</strong> STRONGLY RECOMMENDED TO BUY NOW! 🎯
                                                </small>
                                            {% elif is_partial_sell %}
                                                <span style="color: #800000; font-weight: bold;">Partial Sell Signal ⚠️</span>
                                                <br><small style="color: #800000; font-weight: bold;">
                                                    Consider selling 10-20% of your position
                                                </small>
                                            {% else %}
                                                <span style="color: #00D632; font-weight: bold;">Bullish - Hold 🎯</span>
                                            {% endif %}
                                        {% else %}
                                            {% if is_death_cross %}
                                                <span style="color: #FF3B30; font-weight: bold;">Welcome to the Bear Market! 🐻</span>
                                                <br><small style="color: #FF3B30; font-weight: bold; font-size: 1.1em;">
                                                    <strong>SELL! SELL! SELL!</strong> STRONGLY RECOMMENDED TO SELL NOW! ⚠️
                                                </small>
                                            {% elif is_partial_buy %}
                                                <span style="color: #008000; font-weight: bold;">Partial Buy Signal ⚠️</span>
                                                <br><small style="color: #008000; font-weight: bold;">
                                                    Consider buying 10-20% of your position
                                                </small>
                                            {% else %}
                                                <span style="color: #FF3B30; font-weight: bold;">Bearish - Stay Out 🐻</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const weeklyData = JSON.parse('{{ weekly_data|tojson|safe }}');
    const currentWeekData = JSON.parse('{{ analysis.current_week_data|tojson|safe }}');
    const previousWeekData = JSON.parse('{{ analysis.previous_week_data|tojson|safe }}');
    const previousPrevWeekData = JSON.parse('{{ analysis.previous_prev_week_data|tojson|safe }}');
    
    // Filter data for 2024 and 2025
    const filteredData = weeklyData.filter(week => {
        const date = new Date(week.monday_date);
        return date.getFullYear() >= 2024;
    });
    
    // Prepare data for the chart
    const dates = filteredData.map(function(week) { return week.date_formatted; });
    const macdValues = filteredData.map(function(week) { return week.macd; });
    const signalValues = filteredData.map(function(week) { return week.signal; });
    const distances = filteredData.map(function(week) { return week.distance; });
    
    // Create the chart
    const ctx = document.getElementById('macdChart').getContext('2d');
    const macdChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'MACD',
                    data: macdValues,
                    borderColor: '#0052FF',
                    backgroundColor: 'rgba(0, 82, 255, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false
                },
                {
                    label: 'Signal Line',
                    data: signalValues,
                    borderColor: '#FF3B30',
                    backgroundColor: 'rgba(255, 59, 48, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false
                },
                {
                    label: 'Distance',
                    data: distances,
                    type: 'bar',
                    backgroundColor: distances.map(d => d > 0 ? 'rgba(0, 214, 50, 0.5)' : 'rgba(255, 59, 48, 0.5)'),
                    borderColor: distances.map(d => d > 0 ? '#00D632' : '#FF3B30'),
                    borderWidth: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            onClick: function(evt, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const weekData = filteredData[index];
                    if (weekData) {
                        updateSelectedWeekAnalysis(weekData);
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(4);
                            }
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function(value, index) {
                            const weekData = filteredData[index];
                            if (!weekData) return '';
                            
                            const date = new Date(weekData.monday_date);
                            
                            // Always show January 1st, 2024
                            if (date.getFullYear() === 2024 && date.getMonth() === 0 && date.getDate() === 1) {
                                return 'Jan 1, 2024';
                            }
                            
                            // Show every 4th week
                            if (index % 4 === 0) {
                                return weekData.date_formatted;
                            }
                            
                            return '';
                        },
                        autoSkip: false
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    // Add click handlers to historical rows
    document.querySelectorAll('.historical-row').forEach(row => {
        row.addEventListener('click', function() {
            const date = this.dataset.date;
            const weekData = weeklyData.find(week => week.monday_date === date);
            if (weekData) {
                updateSelectedWeekAnalysis(weekData);
            }
        });
    });

    // Function to update Selected Week Analysis
    function updateSelectedWeekAnalysis(weekData) {
        // Update selected week information
        document.getElementById('selectedDate').textContent = weekData.date_formatted;
        document.getElementById('selectedPrice').textContent = '$' + weekData.price.toFixed(2);
        document.getElementById('selectedMACD').textContent = weekData.macd.toFixed(4);
        document.getElementById('selectedSignal').textContent = weekData.signal.toFixed(4);
        document.getElementById('selectedDistance').textContent = weekData.distance.toFixed(4);
        document.getElementById('selectedTrend').textContent = weekData.distance > 0 ? 'Bullish' : 'Bearish';

        // Find the current week's index and previous weeks
        const currentIndex = weeklyData.findIndex(w => w.monday_date === weekData.monday_date);
        const previousWeek = currentIndex > 0 ? weeklyData[currentIndex - 1] : null;
        const previousPrevWeek = currentIndex > 1 ? weeklyData[currentIndex - 2] : null;

        // Update status and recommendation based on trend and momentum
        const statusElement = document.getElementById('selectedStatus');
        const recommendationElement = document.getElementById('selectedRecommendation');

        if (weekData.distance > 0) {
            statusElement.className = 'text-success';
            recommendationElement.className = 'text-success';

            if (previousWeek && previousWeek.distance <= 0) {
                // Golden Cross
                statusElement.innerHTML = '<strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.';
                recommendationElement.innerHTML = '<strong>BUY SIGNAL:</strong> Golden Cross detected. Consider entering long positions.';
            } else if (previousWeek && previousPrevWeek && 
                      weekData.macd < previousWeek.macd && 
                      previousWeek.macd > previousPrevWeek.macd) {
                // Reversal down after MACD was increasing
                statusElement.innerHTML = '<strong>Reversal Warning!</strong> MACD is decreasing after an uptrend.';
                recommendationElement.innerHTML = '<strong>PARTIAL SELL RECOMMENDATION:</strong> Consider selling 10-20% of your position. Hold the rest until Death Cross.';
            } else if (previousWeek && previousPrevWeek && 
                      weekData.macd > previousWeek.macd && 
                      previousWeek.macd < previousPrevWeek.macd) {
                // Reversal up after a decrease in MACD
                statusElement.innerHTML = '<strong>Recovery Alert!</strong> MACD is increasing after a decrease.';
                recommendationElement.innerHTML = '<strong>PARTIAL BUY OPPORTUNITY:</strong> Consider buying 10-20% of your position. MACD is recovering.';
            } else {
                // Stable or no previous data
                statusElement.textContent = 'MACD remains above signal line.';
                recommendationElement.textContent = 'Hold existing positions. MACD remains bullish.';
            }
        } else {
            // Bearish (MACD < 0)
            statusElement.className = 'text-danger';
            recommendationElement.className = 'text-danger';

            if (previousWeek && previousWeek.distance > 0) {
                // Death Cross
                statusElement.innerHTML = '<strong>Death Cross Alert!</strong> MACD has crossed below the signal line.';
                recommendationElement.innerHTML = '<strong>SELL SIGNAL:</strong> Death Cross detected. Exit all positions.';
            } else if (previousWeek && previousPrevWeek && 
                      weekData.macd > previousWeek.macd && 
                      previousWeek.macd < previousPrevWeek.macd &&
                      previousPrevWeek.macd < previousPrevWeek.signal) {
                // Reversal up after MACD was in a clear downtrend
                statusElement.innerHTML = '<strong>Reversal Warning!</strong> MACD is increasing after a clear downtrend.';
                recommendationElement.innerHTML = '<strong>PARTIAL BUY OPPORTUNITY:</strong> Consider buying 10-20% of your position. Hold the rest until Golden Cross.';
            } else {
                // Stable or no previous data
                statusElement.textContent = 'MACD remains below signal line.';
                recommendationElement.textContent = 'Stay on the sidelines. MACD remains bearish.';
            }
        }
        
        document.getElementById('currentWeekCard').scrollIntoView({ behavior: 'smooth' });
    }

    // Add click handler for Current Week button
    document.getElementById('currentWeekBtn').addEventListener('click', function() {
        updateSelectedWeekAnalysis(currentWeekData);
    });

    // Initialize with current week data
    updateSelectedWeekAnalysis(currentWeekData);
});
</script>
{% endblock %} 