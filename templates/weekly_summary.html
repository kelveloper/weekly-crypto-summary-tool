{% extends "base.html" %}

{% block title %}Bitcoin Weekly MACD (12, 26, 9){% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Bitcoin Weekly MACD Analysis</h2>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% else %}
        <!-- Current Week Analysis -->
        <div class="card mb-4" id="currentWeekCard">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">Selected Week Analysis</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Weekly Performance</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <th>Date:</th>
                                    <td id="selectedDate">{{ analysis.current_week_data.date.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                <tr>
                                    <th>Price:</th>
                                    <td id="selectedPrice">${{ "%.2f"|format(analysis.current_week_data.price) }}</td>
                                </tr>
                                <tr>
                                    <th>MACD:</th>
                                    <td id="selectedMACD">{{ "%.4f"|format(analysis.current_week_data.macd) }}</td>
                                </tr>
                                <tr>
                                    <th>Signal:</th>
                                    <td id="selectedSignal">{{ "%.4f"|format(analysis.current_week_data.signal) }}</td>
                                </tr>
                                <tr>
                                    <th>Distance:</th>
                                    <td id="selectedDistance" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.4f"|format(analysis.current_week_data.distance) }}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Trend:</th>
                                    <td>
                                        <span id="selectedTrend" class="badge {% if analysis.current_week_data.distance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ 'Bullish' if analysis.current_week_data.distance > 0 else 'Bearish' }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Signal Analysis</h4>
                        <div id="signalAnalysis" class="alert {% if analysis.current_week_data.distance > 0 %}alert-success{% else %}alert-danger{% endif %}">
                            <h5>Current Status:</h5>
                            <p id="selectedStatus">
                                {% if analysis.current_week_data.distance > 0 %}
                                    {% if analysis.previous_week_data.distance <= 0 %}
                                        <strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.
                                    {% else %}
                                        Bullish trend continuing. MACD remains above signal line.
                                    {% endif %}
                                {% else %}
                                    {% if analysis.previous_week_data.distance > 0 %}
                                        <strong>Death Cross Alert!</strong> MACD has crossed below the signal line.
                                    {% else %}
                                        Bearish trend continuing. MACD remains below signal line.
                                    {% endif %}
                                {% endif %}
                            </p>
                            <h5>Momentum:</h5>
                            <p id="selectedMomentum">
                                {% if analysis.current_week_data.distance > analysis.previous_week_data.distance %}
                                    Momentum is increasing (Distance widening)
                                {% else %}
                                    Momentum is decreasing (Distance narrowing)
                                {% endif %}
                            </p>
                            <h5>Recommendation:</h5>
                            <p id="selectedRecommendation">{{ analysis.recommendation }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Analysis -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">Historical Analysis (2025)</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Price</th>
                                <th>MACD</th>
                                <th>Signal</th>
                                <th>Distance</th>
                                <th>Trend</th>
                                <th>Signal Event</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in weekly_data %}
                            <tr class="historical-row" style="cursor: pointer;" 
                                data-date="{{ week.date.strftime('%Y-%m-%d') }}"
                                data-price="{{ "%.2f"|format(week.price) }}"
                                data-macd="{{ "%.4f"|format(week.macd) }}"
                                data-signal="{{ "%.4f"|format(week.signal) }}"
                                data-distance="{{ "%.4f"|format(week.distance) }}"
                                data-index="{{ loop.index0 }}">
                                <td>{{ week.date.strftime('%Y-%m-%d') }}</td>
                                <td>${{ "%.2f"|format(week.price) }}</td>
                                <td>{{ "%.4f"|format(week.macd) }}</td>
                                <td>{{ "%.4f"|format(week.signal) }}</td>
                                <td class="{% if week.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.4f"|format(week.distance) }}
                                </td>
                                <td>
                                    <span class="badge {% if week.distance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ 'Bullish' if week.distance > 0 else 'Bearish' }}
                                    </span>
                                </td>
                                <td>
                                    {% if loop.index > 1 %}
                                        {% if week.distance > 0 and weekly_data[loop.index0 - 1].distance <= 0 %}
                                            <span class="badge bg-success">Golden Cross</span>
                                        {% elif week.distance <= 0 and weekly_data[loop.index0 - 1].distance > 0 %}
                                            <span class="badge bg-danger">Death Cross</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const weeklyData = {{ weekly_data|tojson|safe }};
    
    document.querySelectorAll('.historical-row').forEach(row => {
        row.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            const currentData = weeklyData[index];
            const previousData = index > 0 ? weeklyData[index - 1] : null;
            
            // Update Weekly Performance
            document.getElementById('selectedDate').textContent = this.dataset.date;
            document.getElementById('selectedPrice').textContent = '$' + this.dataset.price;
            document.getElementById('selectedMACD').textContent = this.dataset.macd;
            document.getElementById('selectedSignal').textContent = this.dataset.signal;
            
            const distance = parseFloat(this.dataset.distance);
            const distanceElement = document.getElementById('selectedDistance');
            distanceElement.textContent = this.dataset.distance;
            distanceElement.className = distance > 0 ? 'text-success' : 'text-danger';
            
            const trendElement = document.getElementById('selectedTrend');
            trendElement.textContent = distance > 0 ? 'Bullish' : 'Bearish';
            trendElement.className = 'badge ' + (distance > 0 ? 'bg-success' : 'bg-danger');
            
            // Update Signal Analysis
            const signalAnalysis = document.getElementById('signalAnalysis');
            signalAnalysis.className = 'alert ' + (distance > 0 ? 'alert-success' : 'alert-danger');
            
            let status = '';
            let momentum = '';
            let recommendation = '';
            
            if (previousData) {
                const prevDistance = previousData.distance;
                
                if (distance > 0) {
                    if (prevDistance <= 0) {
                        status = '<strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.';
                        recommendation = 'ðŸš€ PERFECT BUY SIGNAL! ðŸš€ This is the start of a bull market! MACD has crossed above signal line. This is your chance to buy aggressively as we\'re likely entering a strong uptrend.';
                    } else {
                        status = 'Bullish trend continuing. MACD remains above signal line.';
                        if (distance > prevDistance) {
                            recommendation = 'ðŸ“ˆ HOLD STRONG! ðŸ“ˆ Bullish trend is strengthening. Keep your positions as the momentum is increasing. This is not the time to sell.';
                        } else {
                            recommendation = 'âš ï¸ CAUTION: Reversal Signal! âš ï¸ Distance is decreasing from previous week. This could indicate we\'re reaching a top. Consider taking profits or selling a portion of your holdings. Perfect time to secure some gains!';
                        }
                    }
                } else {
                    if (prevDistance > 0) {
                        status = '<strong>Death Cross Alert!</strong> MACD has crossed below the signal line.';
                        recommendation = 'ðŸ˜¢ BEAR MARKET ALERT! ðŸ˜¢ MACD has crossed below signal line. We\'re entering a bear market phase. Expect downward pressure for several weeks. This is not the time to buy.';
                    } else {
                        status = 'Bearish trend continuing. MACD remains below signal line.';
                        if (distance < prevDistance) {
                            recommendation = 'ðŸ’ª ACCUMULATION TIME! ðŸ’ª Bearish trend is strengthening. This is a great opportunity to start accumulating. Buy in small amounts as prices may continue to drop.';
                        } else {
                            recommendation = 'ðŸŽ¯ STRONG BUY SIGNAL! ðŸŽ¯ Distance is becoming less negative. This indicates a potential reversal. Start buying more aggressively as we might be approaching the bottom. Perfect time to increase your position!';
                        }
                    }
                }
                
                momentum = distance > prevDistance ? 
                    'Momentum is increasing (Distance widening)' : 
                    'Momentum is decreasing (Distance narrowing)';
            }
            
            document.getElementById('selectedStatus').innerHTML = status;
            document.getElementById('selectedMomentum').textContent = momentum;
            document.getElementById('selectedRecommendation').textContent = recommendation;
            
            // Scroll to the top of the analysis
            document.getElementById('currentWeekCard').scrollIntoView({ behavior: 'smooth' });
        });
    });
});
</script>
{% endblock %} 