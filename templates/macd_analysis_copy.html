{% extends "base.html" %}

{% block title %}{{ current_coin }} MACD Analysis{% endblock %}

{% block content %}
<style>
    :root {
        --coinbase-blue: #0052FF;
        --apple-gray: #F5F5F7;
        --apple-dark: #1D1D1F;
        --success-green: #00D632;
        --danger-red: #FF3B30;
        --light-green: #e6ffe6;
        --light-red: #ffe6e6;
        --light-yellow: rgba(255, 204, 0, 0.2);
    }

    .coin-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .coin-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--coinbase-blue);
        border-radius: 8px;
        background: white;
        color: var(--coinbase-blue);
        cursor: pointer;
        transition: all 0.3s;
    }

    .coin-btn:hover {
        background: var(--coinbase-blue);
        color: white;
    }

    .coin-btn.active {
        background: var(--coinbase-blue);
        color: white;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">{{ current_coin }} Weekly MACD Analysis</h2>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% else %}
        <!-- Coin Selector -->
        <div class="coin-selector">
            {% for coin in portfolio_coins %}
                {% if coin != 'USD' %}
                    <button class="coin-btn {% if coin == current_coin %}active{% endif %}" data-coin="{{ coin }}">
                        {{ coin }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>

        {% if current_coin in ['USDT', 'USDC', 'DAI', 'BUSD', 'TUSD', 'USDP', 'USDD', 'FRAX', 'GUSD', 'LUSD', 'MIM', 'USTC', 'USN', 'USDK', 'USDS', 'USDTZ', 'USX', 'USDT+', 'USDT.e', 'USDC.e', 'DAI.e'] %}
            <!-- Stablecoin Message -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Stablecoin Alert! üö®</h3>
                </div>
                <div class="card-body text-center">
                    <div class="alert alert-info">
                        <h4>ü§î Analyzing {{ current_coin }}...</h4>
                        <p class="lead">Wait a minute... This is a stablecoin! ü§¶‚Äç‚ôÇÔ∏è</p>
                        <p>MACD analysis for {{ current_coin }} is like trying to predict the weather in a climate-controlled room.</p>
                        <p>It's always $1.00, just like my bank account after paying rent! üòÖ</p>
                        <p>Maybe try analyzing a coin that actually moves? Just a suggestion! üòâ</p>
                    </div>
                    <img src="https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif" alt="Stablecoin Meme" class="img-fluid rounded" style="max-width: 300px;">
                </div>
            </div>
        {% else %}
            <!-- MACD Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">MACD Chart</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 500px; width: 100%;">
                        <canvas id="macdChart"></canvas>
                    </div>
                    <div class="text-center mt-2" style="color: #6E6E73; font-size: 0.9rem;">
                        Monday's of the Week
                    </div>
                </div>
            </div>

            <!-- Current Week Analysis -->
            <div class="card mb-4" id="currentWeekCard">
                <div class="card-header">
                    <h3 class="mb-0">Selected Week Analysis</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Weekly Performance</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <tr>
                                        <th>Date:</th>
                                        <td id="selectedDate">{{ analysis.current_week_data.date_formatted }}</td>
                                    </tr>
                                    <tr>
                                        <th>Price:</th>
                                        <td id="selectedPrice">${{ "%.2f"|format(analysis.current_week_data.price) }}</td>
                                    </tr>
                                    <tr>
                                        <th>MACD:</th>
                                        <td id="selectedMACD">{{ "%.4f"|format(analysis.current_week_data.macd) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Signal:</th>
                                        <td id="selectedSignal">{{ "%.4f"|format(analysis.current_week_data.signal) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Distance:</th>
                                        <td id="selectedDistance" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.4f"|format(analysis.current_week_data.distance) }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Trend:</th>
                                        <td>
                                            <span id="selectedTrend" class="badge {% if analysis.current_week_data.distance > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ 'Bullish' if analysis.current_week_data.distance > 0 else 'Bearish' }}
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Analysis & Recommendation</h4>
                            <div class="analysis-section">
                                <h5>Current Status:</h5>
                                <p id="selectedStatus" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if analysis.current_week_data.distance > 0 %}
                                        {% if analysis.previous_week_data and analysis.previous_week_data.distance <= 0 %}
                                            <strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.
                                        {% else %}
                                            Bullish trend continuing. MACD remains above signal line.
                                        {% endif %}
                                    {% else %}
                                        {% if analysis.previous_week_data and analysis.previous_week_data.distance > 0 %}
                                            <strong>Death Cross Alert!</strong> MACD has crossed below the signal line.
                                        {% else %}
                                            Bearish trend continuing. MACD remains below signal line.
                                        {% endif %}
                                    {% endif %}
                                </p>
                                <h5>Recommendation:</h5>
                                <p id="selectedRecommendation" class="{% if analysis.current_week_data.distance > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if analysis.current_week_data.distance > 0 %}
                                        {% if analysis.previous_week_data and analysis.previous_week_data.distance <= 0 %}
                                            Consider entering a long position as momentum is shifting bullish.
                                        {% else %}
                                            Maintain long positions as the bullish trend continues.
                                        {% endif %}
                                    {% else %}
                                        {% if analysis.previous_week_data and analysis.previous_week_data.distance > 0 %}
                                            Consider exiting long positions as momentum is shifting bearish.
                                        {% else %}
                                            Maintain short positions or stay on the sidelines as the bearish trend continues.
                                        {% endif %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Historical Analysis (2024-2025)</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Price</th>
                                    <th>MACD</th>
                                    <th>Signal</th>
                                    <th>Distance</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week in weekly_data %}
                                    {% if week.monday_date.startswith('2024') or week.monday_date.startswith('2025') %}
                                    <tr class="historical-row" 
                                        data-index="{{ loop.index0 }}"
                                        data-date="{{ week.monday_date }}"
                                        data-price="{{ week.price }}"
                                        data-macd="{{ week.macd }}"
                                        data-signal="{{ week.signal }}"
                                        data-distance="{{ week.distance }}"
                                        {% if week.is_reversal or week.market_message or week.special_recommendation %}
                                            {% if week.highlight_color == 'lightgreen' %}
                                                style="background-color: var(--light-green);"
                                            {% elif week.highlight_color == 'lightred' %}
                                                style="background-color: var(--light-red);"
                                            {% elif week.highlight_color == 'lightyellow' %}
                                                style="background-color: var(--light-yellow);"
                                            {% endif %}
                                        {% endif %}>
                                        <td>{{ week.monday_date }}</td>
                                        <td>${{ "%.2f"|format(week.price) }}</td>
                                        <td>{{ "%.4f"|format(week.macd) }}</td>
                                        <td>{{ "%.4f"|format(week.signal) }}</td>
                                        <td>{{ "%.4f"|format(week.distance) }}</td>
                                        <td>
                                            {{ week.trend }}
                                            {% if week.market_message %}
                                                <br><small style="color: {% if week.trend == 'Bullish' %}#00D632{% else %}#FF3B30{% endif %}; font-weight: bold; font-size: 1.1em;">{{ week.market_message }}</small>
                                            {% elif week.special_recommendation %}
                                                <br><small style="color: {% if week.highlight_color == 'lightgreen' %}#00D632{% elif week.highlight_color == 'lightred' %}#FF3B30{% else %}#6E6E73{% endif %};">{{ week.special_recommendation }}</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    {% if analysis and analysis.current_week_data %}
    console.log('Analysis data available');
    const weeklyData = JSON.parse('{{ weekly_data|tojson|safe }}');
    console.log('Weekly Data:', weeklyData);
    const currentWeekData = JSON.parse('{{ analysis.current_week_data|tojson|safe }}');
    console.log('Current Week Data:', currentWeekData);
    const previousWeekData = {% if analysis.previous_week_data %}{{ analysis.previous_week_data|tojson|safe }}{% else %}null{% endif %};
    console.log('Previous Week Data:', previousWeekData);
    const portfolioCoins = JSON.parse('{{ portfolio_coins|tojson|safe }}');
    console.log('Portfolio Coins:', portfolioCoins);
    const currentCoin = '{{ current_coin }}';
    console.log('Current Coin:', currentCoin);
    
    // Add click handlers to coin selector buttons
    document.querySelectorAll('.coin-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const selectedCoin = this.dataset.coin;
            console.log('Coin selected:', selectedCoin);
            if (selectedCoin !== currentCoin) {
                // Update URL with selected coin
                window.location.href = `/macd_analysis_copy?coin=${selectedCoin}`;
            }
        });
    });

    // Filter data for 2024 and 2025
    const filteredData = weeklyData.filter(week => {
        const date = new Date(week.monday_date);
        return date.getFullYear() >= 2024;
    });
    console.log('Filtered Data (2024-2025):', filteredData);
    
    // Prepare data for the chart
    const dates = filteredData.map(function(week) { return week.date_formatted; });
    const macdValues = filteredData.map(function(week) { return week.macd; });
    const signalValues = filteredData.map(function(week) { return week.signal; });
    const distances = filteredData.map(function(week) { return week.distance; });
    console.log('Chart Data:', { dates, macdValues, signalValues, distances });
    
    // Create the chart
    const ctx = document.getElementById('macdChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'MACD',
                    data: macdValues,
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                },
                {
                    label: 'Signal',
                    data: signalValues,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                },
                {
                    label: 'Distance',
                    data: distances,
                    type: 'bar',
                    backgroundColor: distances.map(d => d >= 0 ? 'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)'),
                    borderColor: distances.map(d => d >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                    borderWidth: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'MACD & Signal',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Distance',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(4);
                            }
                            return label;
                        }
                    },
                    bodyFont: {
                        size: 14
                    }
                }
            }
        }
    });

    // Add click handlers to historical rows
    document.querySelectorAll('.historical-row').forEach(row => {
        row.addEventListener('click', function() {
            const date = this.dataset.date;
            const weekData = weeklyData.find(week => week.monday_date === date);
            if (weekData) {
                updateSelectedWeekAnalysis(weekData);
            }
        });
    });

    // Function to update Selected Week Analysis
    function updateSelectedWeekAnalysis(weekData) {
        // Update selected week information
        document.getElementById('selectedDate').textContent = weekData.date_formatted;
        document.getElementById('selectedPrice').textContent = '$' + weekData.price.toFixed(2);
        document.getElementById('selectedMACD').textContent = weekData.macd.toFixed(4);
        document.getElementById('selectedSignal').textContent = weekData.signal.toFixed(4);
        document.getElementById('selectedDistance').textContent = weekData.distance.toFixed(4);
        document.getElementById('selectedTrend').textContent = weekData.distance > 0 ? 'Bullish' : 'Bearish';

        // Find the current week's index and previous weeks
        const currentIndex = weeklyData.findIndex(w => w.monday_date === weekData.monday_date);
        const previousWeek = currentIndex > 0 ? weeklyData[currentIndex - 1] : null;
        const previousPrevWeek = currentIndex > 1 ? weeklyData[currentIndex - 2] : null;

        // Update status and recommendation based on trend and momentum
        const statusElement = document.getElementById('selectedStatus');
        const recommendationElement = document.getElementById('selectedRecommendation');
        const distance = weekData.distance;
        const prevDistance = previousWeek ? previousWeek.distance : null;
        let status = '';
        let recommendation = '';

        if (distance > 0) {
            if (prevDistance <= 0) {
                status = '<strong>Golden Cross Alert!</strong> MACD has crossed above the signal line.';
                recommendation = 'Consider entering a long position as momentum is shifting bullish.';
            } else {
                status = 'Bullish trend continuing. MACD remains above signal line.';
                if (distance > prevDistance) {
                    recommendation = 'Maintain long positions as the bullish trend continues.';
                } else {
                    recommendation = 'Consider taking some profits as momentum may be weakening.';
                }
            }
        } else {
            if (prevDistance > 0) {
                status = '<strong>Death Cross Alert!</strong> MACD has crossed below the signal line.';
                recommendation = 'Consider exiting long positions as momentum is shifting bearish.';
            } else {
                status = 'Bearish trend continuing. MACD remains below signal line.';
                if (distance < prevDistance) {
                    recommendation = 'Maintain short positions or stay on the sidelines.';
                } else {
                    recommendation = 'Consider starting to accumulate as momentum may be improving.';
                }
            }
        }
        
        statusElement.innerHTML = status;
        recommendationElement.textContent = recommendation;
        
        // Update text colors based on trend
        statusElement.className = distance > 0 ? 'text-success' : 'text-danger';
        recommendationElement.className = distance > 0 ? 'text-success' : 'text-danger';
        
        document.getElementById('currentWeekCard').scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize with current week data
    updateSelectedWeekAnalysis(currentWeekData);
    {% else %}
    // Handle case when there's no data
    document.getElementById('macd-chart').innerHTML = '<div class="alert alert-warning">No data available for analysis</div>';
    document.getElementById('current-week-analysis').innerHTML = '<div class="alert alert-warning">No data available for analysis</div>';
    document.getElementById('historical-analysis').innerHTML = '<div class="alert alert-warning">No data available for analysis</div>';
    {% endif %}
});
</script>
{% endblock %} 